<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prospectors Price Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const RESOURCE_NAMES = {
      2: 'Wood',
      3: 'Stone',
      4: 'Coal',
      5: 'Clay',
      6: 'Iron Ore',
      9: 'Wood Beam',
      14: 'Steel Block',
      15: 'Iron Plate',
      16: 'Nails',
      17: 'Shovel',
      18: 'Spade',
      19: 'Pickax',
      20: 'Hammer',
      22: 'Axe',
      25: 'Cart',
      31: 'Coffee Beans',
      50: 'Mug Of Coffee',
      55: 'Donkey',
      // …add more here.
    };

    // Now raw listings table
    const ListingsTable = ({ listings, onSort, sortConfig }) => (
      <div className="overflow-x-auto">
        <table className="min-w-full bg-white divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              {['resource','typeId','price','amount','health'].map(key=>{
                const labels = {
                  resource: 'Resource',
                  typeId: 'Type ID',
                  price: 'Price',
                  amount: 'Amount',
                  health: 'Health'
                };
                return (
                  <th key={key}
                      className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer"
                      onClick={()=>onSort(key)}>
                    {labels[key]}
                    {sortConfig.key===key && (sortConfig.direction==='asc'?' ↑':' ↓')}
                  </th>
                );
              })}
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {listings.map((item, idx)=>{
              const { type_id, price, stuff: { amount, health } } = item;
              return (
                <tr key={idx} className="hover:bg-gray-50">
                  <td className="px-6 py-4 whitespace-nowrap">
                    {RESOURCE_NAMES[type_id]||'Unknown'}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">{type_id}</td>
                  <td className="px-6 py-4 whitespace-nowrap">{price}</td>
                  <td className="px-6 py-4 whitespace-nowrap">{amount}</td>
                  <td className="px-6 py-4 whitespace-nowrap">{health}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    );

    // Chart stays unchanged (aggregates historicalData), we keep it intact
    const PriceChart = ({ historicalData, previousPrice }) => {
      const chartRef = React.useRef(null);
      const chartInstance = React.useRef(null);

      React.useEffect(()=>{
        if(chartInstance.current) chartInstance.current.destroy();
        const ctx = chartRef.current.getContext('2d');
        const labels = historicalData.map(d=>d.date);
        const datasets = [{
          label: 'Avg Price',
          data: historicalData.map(d=>d.avgPrice),
          fill: false,
          tension: 0.1
        }];
        if(previousPrice!=null){
          datasets.push({
            label: 'Last Refresh',
            data: labels.map(()=>previousPrice),
            borderDash: [5,5],
            fill: false,
            tension: 0
          });
        }
        chartInstance.current = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets },
          options: { scales:{ y:{ beginAtZero:true } } }
        });
      }, [historicalData, previousPrice]);

      return <canvas ref={chartRef}/>;
    };

    const App = () => {
      const [listings, setListings] = React.useState([]);
      const [sortConfig, setSortConfig] = React.useState({key:'typeId',direction:'asc'});
      const [selectedTypeId, setSelectedTypeId] = React.useState(null);
      const [isLoading, setIsLoading] = React.useState(false);
      const [errorMsg, setErrorMsg] = React.useState(null);
      const [lastUpdated, setLastUpdated] = React.useState(null);

      // reuse your historicalData
      const historicalData = {
        '2':[ /*…*/ ],
        '3':[ /*…*/ ],
      };

      const RPCS = [
        'https://wax.greymass.com',
        'https://apiwax.cryptolions.io',
        'https://wax.cryptolions.io'
      ];

      const fetchMarket = async()=>{
        for(const base of RPCS){
          try {
            const r = await axios.post(
              `${base}/v1/chain/get_table_rows`,
              { json:true, code:'prospectorsn', scope:'prospectorsn',
                table:'market', limit:100 },
              { headers:{'Content-Type':'application/json'} }
            );
            return r.data.rows;
          } catch{}
        }
        throw new Error('All RPCs failed');
      };

      const fetchData = async()=>{
        setIsLoading(true);
        setErrorMsg(null);
        try {
          const rows = await fetchMarket();
          setListings(rows);
          if(!selectedTypeId && rows.length)
            setSelectedTypeId(rows[0].stuff.type_id);
          setLastUpdated(new Date());
        } catch(e){
          setErrorMsg(e.message);
        } finally {
          setIsLoading(false);
        }
      };

      React.useEffect(fetchData, []);

      const sortedListings = React.useMemo(()=>{
        const arr = [...listings];
        const { key, direction } = sortConfig;
        arr.sort((a,b)=>{
          let A, B;
          if(key==='resource'){
            A = RESOURCE_NAMES[a.stuff.type_id]||'Unknown';
            B = RESOURCE_NAMES[b.stuff.type_id]||'Unknown';
          } else if(key==='typeId'){
            A = a.stuff.type_id; B = b.stuff.type_id;
          } else {
            A = a[key]; B = b[key];
            if(key!=='price'){
              A = a.stuff[key]; B = b.stuff[key];
            }
          }
          if(A < B) return direction==='asc'? -1:1;
          if(A > B) return direction==='asc'? 1:-1;
          return 0;
        });
        return arr;
      }, [listings, sortConfig]);

      return (
        <div className="container mx-auto p-4">
          <h1 className="text-3xl font-bold mb-6 text-center">
            Prospectors Price Tracker
          </h1>

          <button
            onClick={fetchData}
            disabled={isLoading}
            className="mb-2 p-2 bg-blue-500 text-white rounded hover:bg-blue-600"
          >
            {isLoading ? 'Refreshing…' : 'Refresh'}
          </button>

          {lastUpdated && (
            <div className="mb-4 text-gray-600">
              Last refreshed: {lastUpdated.toLocaleString()}
            </div>
          )}
          {errorMsg && (
            <div className="bg-red-100 text-red-800 p-3 mb-6 rounded">
              {errorMsg}
            </div>
          )}

          <div className="mb-8">
            <h2 className="text-xl font-semibold mb-4">
              Latest Listings And Prices
            </h2>
            {sortedListings.length
              ? <ListingsTable
                  listings={sortedListings}
                  onSort={k=>setSortConfig(prev=>({
                    key:k,
                    direction: prev.key===k && prev.direction==='asc'?'desc':'asc'
                  }))}
                  sortConfig={sortConfig}
                />
              : <div>No data</div>
            }
          </div>

          <div>
            <h2 className="text-xl font-semibold mb-4">
              Historical Price Trends
            </h2>
            {sortedListings.length > 0 && (
              <select
                value={selectedTypeId||''}
                onChange={e=>setSelectedTypeId(e.target.value)}
                className="mb-4 p-2 border rounded w-full sm:w-48"
              >
                <option value="">Select Type ID</option>
                {Array.from(new Set(sortedListings.map(item=>item.stuff.type_id))).map(id=>(
                  <option key={id} value={id}>
                    {RESOURCE_NAMES[id]||'Unknown'} ({id})
                  </option>
                ))}
              </select>
            )}
            {selectedTypeId && historicalData[selectedTypeId] ? (
              <PriceChart
                historicalData={historicalData[selectedTypeId]}
                previousPrice={null}
              />
            ) : (
              <div>No historical data for this Type ID</div>
            )}
          </div>

          <footer className="mt-8 text-center text-gray-500">
            <p>Powered by WAX Blockchain | Deployed on Vercel</p>
          </footer>
        </div>
      );
    };

    ReactDOM.render(<App />,document.getElementById('root'));
  </script>
</body>
</html>
