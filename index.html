<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prospectors Price Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const RESOURCE_NAMES = {
      2: 'Wood', 3: 'Stone', 4: 'Coal', 5: 'Clay', 6: 'Iron Ore', 7: 'Stone Block',
      8: 'Stone Plate', 9: 'Wood Beam', 11: 'Wood Girder', 14:'Steel Block', 15:'Iron Plate',
      16:'Nails', 17:'Shovel', 18:'Spade', 19:'Pickax', 20:'Hammer', 21:'Sledgehammer',
      22:'Axe', 23:'Saw', 24:'Gold pan', 25:'Cart', 28:'Wagon', 31:'Coffee Beans',
      32:'Chisel', 40:'Stone Rubble', 43:'Tie Cotter', 44:'Rail Tie', 49:'Mug',
      50:'Mug Of Coffee', 55:'Donkey'
    };

    const PriceTable = ({ sortedPrices, onSort, sortConfig, previousPrices, listingsMap, expandedIds, toggleExpand }) => (
      <div className="overflow-x-auto">
        <table className="min-w-full bg-white divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-2"></th>
              {['resource','typeId','average','totalAmount','count','min','max','delta'].map(key => {
                const labels = { resource: 'Resource', typeId: 'Type ID', average: 'Avg Price', totalAmount: 'Total Amount', count: 'Listings', min: 'Min', max: 'Max', delta: 'Δ Price' };
                return (
                  <th key={key} className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" onClick={() => key !== 'delta' && onSort(key)}>
                    {labels[key]}
                    {sortConfig.key === key && (sortConfig.direction === 'asc' ? ' ↑' : ' ↓')}
                  </th>
                );
              })}
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {sortedPrices.map(([typeId, stats]) => {
              const prev = previousPrices[typeId];
              const delta = prev != null ? (stats.average - prev).toFixed(2) : '—';
              const isOpen = expandedIds.has(typeId);
              return (
                <React.Fragment key={typeId}>
                  <tr className="hover:bg-gray-50">
                    <td className="px-4 py-2 whitespace-nowrap">
                      <button onClick={() => toggleExpand(typeId)} className="focus:outline-none">{isOpen ? '▼' : '▶'}</button>
                    </td>
                    <td className="px-4 py-2 whitespace-nowrap">{RESOURCE_NAMES[typeId]||'Unknown'}</td>
                    <td className="px-4 py-2 whitespace-nowrap">{typeId}</td>
                    <td className="px-4 py-2 whitespace-nowrap">{stats.average}</td>
                    <td className="px-4 py-2 whitespace-nowrap">{stats.totalAmount}</td>
                    <td className="px-4 py-2 whitespace-nowrap">{stats.count}</td>
                    <td className="px-4 py-2 whitespace-nowrap">{stats.min}</td>
                    <td className="px-4 py-2 whitespace-nowrap">{stats.max}</td>
                    <td className="px-4 py-2 whitespace-nowrap"><span className={delta>0?'text-green-600':delta<0?'text-red-600':''}>{delta}</span></td>
                  </tr>
                  {isOpen && (
                    <tr className="bg-gray-100">
                      <td colSpan="9" className="px-4 py-2">
                        <table className="min-w-full text-sm">
                          <thead><tr><th className="px-2 py-1 text-left">Price</th><th className="px-2 py-1 text-left">Amount</th></tr></thead>
                          <tbody>
                            {listingsMap[typeId].map((item, idx) => (
                              <tr key={idx}><td className="px-2 py-1">{item.price}</td><td className="px-2 py-1">{item.amount}</td></tr>
                            ))}
                          </tbody>
                        </table>
                      </td>
                    </tr>
                  )}
                </React.Fragment>
              );
            })}
          </tbody>
        </table>
      </div>
    );

    const DataViz = ({ sortedPrices }) => {
      const barRef = React.useRef(null);
      const pieRef = React.useRef(null);
      const barChartInstance = React.useRef(null);
      const pieChartInstance = React.useRef(null);

      const palette = ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40','#C9CBCF','#8EBF8F','#E7A1F2','#A1E7F2','#F2E7A1','#F2A1A1'];

      React.useEffect(() => {
        // Destroy existing charts to avoid duplicates
        if (barChartInstance.current) barChartInstance.current.destroy();
        if (pieChartInstance.current) pieChartInstance.current.destroy();

        // Bar chart: Top 10 avg prices
        const top10 = sortedPrices.slice().sort((a,b) => b[1].average - a[1].average).slice(0,10);
        const labels = top10.map(([id]) => RESOURCE_NAMES[id]||id);
        const dataAvgs = top10.map(([_,stats]) => stats.average);
        const barColors = palette.slice(0, labels.length);
        if (barRef.current) {
          barChartInstance.current = new Chart(barRef.current.getContext('2d'), {
            type: 'bar', data: { labels, datasets: [{ label: 'Avg Price', data: dataAvgs, backgroundColor: barColors, borderColor: barColors, borderWidth: 1 }] },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
          });
        }

        // Pie chart: listing counts
        const allLabels = sortedPrices.map(([id]) => RESOURCE_NAMES[id]||id);
        const allCounts = sortedPrices.map(([_,s]) => s.count);
        const pieColors = palette.slice(0, allLabels.length);
        if (pieRef.current) {
          pieChartInstance.current = new Chart(pieRef.current.getContext('2d'), {
            type: 'pie', data: { labels: allLabels, datasets: [{ data: allCounts, backgroundColor: pieColors, borderColor: '#ffffff', borderWidth: 1 }] },
            options: { responsive: true }
          });
        }
      }, [sortedPrices]);

      return (
        <div className="space-y-8">
          <div>
            <h3 className="text-lg font-semibold mb-2">Top 10 Avg Price</h3>
            <canvas ref={barRef}></canvas>
          </div>
          <div>
            <h3 className="text-lg font-semibold mb-2">Listings Distribution</h3>
            <canvas ref={pieRef}></canvas>
          </div>
        </div>
      );
    };

    const DonateButton = () => { /* unchanged */
      const handleDonate = (token) => {/* ... */};
      return (/* ... */);
    };

    const App = () => {
      const [prices, setPrices] = React.useState({});
      const [previousPrices, setPreviousPrices] = React.useState({});
      const [listingsMap, setListingsMap] = React.useState({});
      const [sortConfig, setSortConfig] = React.useState({ key:'typeId', direction:'asc' });
      const [expandedIds, setExpandedIds] = React.useState(new Set());
      const [isLoading, setIsLoading] = React.useState(false);
      const [errorMsg, setErrorMsg] = React.useState(null);
      const [lastUpdated, setLastUpdated] = React.useState(null);

      const RPCS = ['https://wax.greymass.com','https://apiwax.cryptolions.io','https://wax.cryptolions.io'];

      const fetchAllRows = async () => { /* unchanged */ };
      const process = rows => { /* unchanged */ };
      const buildListingsMap = rows => { /* unchanged */ };

      const fetchData = async () => {
        setIsLoading(true);
        setErrorMsg(null);
        try {
          const stored = JSON.parse(localStorage.getItem('lastPrices')||'{}');
          setPreviousPrices(stored);
          const rows = await fetchAllRows();
          const proc = process(rows);
          setPrices(proc);
          setListingsMap(buildListingsMap(rows));
          localStorage.setItem('lastPrices', JSON.stringify(
            Object.fromEntries(Object.entries(proc).map(([k,v])=>[k,v.average]))
          ));
          setLastUpdated(new Date());
        } catch(e) {
          setErrorMsg(e.message);
        } finally {
          setIsLoading(false);
        }
      };

      React.useEffect(() => { fetchData(); }, []);

      const sorted = React.useMemo(() => { /* unchanged */ }, [prices, sortConfig]);
      const toggleExpand = id => { /* unchanged */ };

      return (
        <div className="container mx-auto p-4">
          <h1 className="text-3xl font-bold mb-6 text-center">Prospectors Price Tracker</h1>
          <button onClick={fetchData} disabled={isLoading} className="mb-2 p-2 bg-blue-500 text-white rounded hover:bg-blue-600">
            {isLoading ? 'Refreshing…' : 'Refresh'}
          </button>
          {lastUpdated && <div className="mb-4 text-gray-600">Last refreshed: {lastUpdated.toLocaleString()}</div>}
          {errorMsg && <div className="bg-red-100 text-red-800 p-3 mb-6 rounded">{errorMsg}</div>}

          <div className="mb-8">
            <div className="flex items-center">
              <h2 className="text-xl font-semibold mb-4">Latest Listings And Prices</h2>
              <DonateButton />
            </div>
            {sorted.length ? <PriceTable sortedPrices={sorted} onSort={k=>setSortConfig(prev=>({ key:k, direction: prev.key===k && prev.direction==='asc'? 'desc':'asc' }))} sortConfig={sortConfig} previousPrices={previousPrices} listingsMap={listingsMap} expandedIds={expandedIds} toggleExpand={toggleExpand} /> : <div>No data</div>}
          </div>

          <div>
            <h2 className="text-xl font-semibold mb-4">Data Visualizations</h2>
            {sorted.length ? <DataViz sortedPrices={sorted} /> : <div>No data to visualize</div>}
          </div>

          <footer className="mt-8 text-center text-gray-500">
            <p>Powered by WAX Blockchain | Deployed on Vercel</p>
          </footer>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
